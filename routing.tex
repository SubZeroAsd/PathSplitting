\section{Routing}
\label{sec:routing}

\begin{figure*}[htb]
	\begin{center}	
		\textbf{Variables and functions:}
		
		\begin{tabular}{r l}
			$\Graph$ & the payment-channel network graph. $\nodes$ is the set of nodes and $\edges$ is the set of channels\\
			$\LM$ & set of landmarks ($\LM \subset \nodes$) \\
			$\Corrupted$ & set of corrupted nodes ($\Corrupted \subset \nodes$) \\
			$\initflag$ & Flag to initialize the functionality. Initially $\initflag = \bot$\\
			$\distfun$ & function to compute the distance between the identifiers of two nodes\\
			$\textit{ngb}$ & function to compute the neighbors of a node in $\Graph$\\
			$\nodeid{\node}{\nodelandmark}$ & identifier of node $\node$ in the tree rooted at landmark $\nodelandmark$ 
		\end{tabular}
	\framebox[\textwidth]{
		\begin{minipage}[t]{0.25\textwidth}
%		\procedure[mode=text]{Corrupt$(\node)$}{
%		Upon invocation by $\sdv$: \\
%		\quad If $\initflag = \bot$ then add $\node$ to $\Corrupted$
%		}
		\procedure[mode=text]{InitDone$(\distfun)$}{
		Upon invocation by $\sdv$:\\
		\quad Store $\distfun$\\
		\quad Set $\initflag := \top$
		}	
		\procedure[mode=text]{AddChannel$(\node_j)$}{
		Upon invocation by $\node_i$:\\
		\quad Add $\node_i$ and $\node_j$ to $\nodes$\\
		\quad Add $(\node_i, \node_j)$ to $\edges$\\
		\quad $\send(\node_i, \node_j)$ to $\node_j$
		%\quad If $\node_j \in \Corrupted$ then $\send((\node_i, \node_j))$ to $\sdv$ 
		}
		\procedure[mode=text]{AddLandmark$()$}{
		Upon invocation by $\node_i$:\\
		\quad Add $\node_i$ to $\LM$\\
		\quad $\send(\node_i)$ to $\sdv$
		}			
		\end{minipage}
		\begin{minipage}[t]{0.33\textwidth}
		\procedure[mode=text]{SetRoutes$()$}{
		Upon invocation by $\nodelandmark \in \LM$:\\
		\quad Enqueue $\nodelandmark$ in $\QQ$\\
		\quad While $\QQ$ is not empty do:\\
		\quad \quad Dequeue $\node$ from $\QQ$\\
		\quad \quad For every $\node'$ neighbor of $\node$ do:\\
		\quad \quad \quad $\send(\nodelandmark, \node')$ to $\node$\\
		\quad \quad \quad $\receive(b)$ from $\node$\\
		\quad \quad \quad If $b = \top$ then\\
		\quad \quad \quad \quad If $\nodeid{\node'}{\nodelandmark}$ is not set yet then:\\
		\quad \quad \quad \quad \quad Compute random number $r$\\
		\quad 
		\quad \quad \quad \quad Set $\nodeid{\node'}{\nodelandmark} := \textit{concatenate}(\nodeid{\node}{\nodelandmark}, r)$\\
		\quad \quad \quad \quad \quad If $\node' \in \Corrupted$ then $\send(\nodeid{\node'}{\nodelandmark})$ to $\sdv$\\
		\quad \quad \quad \quad Enqueue $\node'$ in $\QQ$
		}
		\end{minipage}
		\begin{minipage}[t]{0.4\textwidth}
		\procedure[mode=text]{RoutePay($\node_r$)}{
		Upon invocation by $\node_s$:\\
		$\send(\node_s)$ to $\node_r$\\
		$\receive(\nodeid{\node_r}{l_1}, \ldots, \nodeid{\node_r}{l_k}$ from $\node_r$\\
		for $i \in \{1, \ldots, k\}$ do\\
		\quad $\send(\nodeid{\node_r}{l_i}$ to $\node_s$\\
		\quad $\receive(b)$ from $\node_s$\\
		\quad If $b = \top$ then \\
		\quad \quad Set $\node^* := \node_s$\\
		\quad \quad While $\node^* \neq \node_r$ and $\node^* \neq \bot$ do \\
		\quad \quad \quad Compute $\node_i$ s.t. $\node_i \in \textit{ngb}(\node^*))$ and $\textit{min}(\distfun(\node^*, \node_i))$\\
%		\quad \quad $\send(\nodeid{\node_r}{l_i})$ to $\node_i$\\
%		\quad \quad $\receive(b)$ from $\node_i$\\
%		\quad \quad If $b = bot$ then set $\node^* := \bot$\\
%		\quad \quad Else then set $\node^* := \node_i$
		}	
		\end{minipage}
	}
	\end{center}
	
	\caption{Ideal functionality for routing}
	\label{fig:ideal-routing}
\end{figure*}
